---

- name: Copy gpg-with-sec script
  copy: src=gpg-with-sec.sh dest=/usr/local/bin/gpg-with-sec mode=0755
  become: yes

- name: Create gnupg directory
  file: path=~/.gnupg state=directory mode=0700

- name: Copy configuration files
  file: src=gnupg/{{item}} dest=~/.gnupg/{{item}} mode=0600
  with_items:
    - gpg.conf
    - gpg-agent.conf
    - scdaemon.conf

- name: Copy udev rules
  copy: src=40-nitrokey.rules dest=/etc/udev/rules.d
  become: yes

- name: Disable Gnome-keyring
  file: path={{item}} state=absent
  become: yes
  with_items:
    - /etc/xdg/autostart/gnome-keyring-gpg.desktop
    - /etc/xdg/autostart/gnome-keyring-gpg-pantheon.desktop
    - /etc/xdg/autostart/gnome-keyring-ssh.desktop
    - /etc/xdg/autostart/gnome-keyring-ssh-pantheon.desktop

- name: Disable ssh-agent
  file: path=/etc/X11/Xsession.d/90x11-common_ssh-agent state=absent
  become: yes

- name: Install libccid drivers
  file: src=libccid_Info.plist dest=/etc/libccid_Info.plist
  become: yes

- name: Install gpg software
  apt: name={{item}} state=installed
  become: yes
  with_items:
    - gnupg2
    - libccid
    - pcscd
    - gpgsm

- name: Start pcscd service
  service: name=pcscd state=started enabled=yes
  become: yes
